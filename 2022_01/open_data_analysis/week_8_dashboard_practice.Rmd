```{r setup, include=FALSE}
# rm(list=ls())
library(flexdashboard)
library(sf)
library(tmap)
tmap_mode("view")
library(tidyverse)
library(mapdeck)
set_token("pk.eyJ1Ijoic3BlYXI1MzA2IiwiYSI6ImNremN5Z2FrOTI0ZGgycm45Mzh3dDV6OWQifQ.kXGWHPRjnVAEHgVgLzXn2g")
Sys.setlocale("LC_ALL","Korean") # 언어 한글로
```

### Task 설명

#### 분석 데이터
1. 인천공항에서 출발/도착하는 1일치(2019년 6월 29일)의 이동데이터
2. 수도권의 행정구역경계 정보

```{r}
dat <- read_rds("./data/test.rds")
region <- read_rds("./data/region.rds")

# region2 <- rmapshaper::ms_simplify(region, keep = 0.1, #keep값을 높여줄수록 simple 해짐
                                   # keep_shapes = TRUE)
```

#### 시각화 목록

1. 행정구역별 승용차 분담율 및 통행량
  1.1 읍면동별 승용차 분담율(%)
  1.2 읍면동별 승용차 통행량(명명)
  1.3 시군구별 승용차 분담율(%)
  1.4 시군구별 승용차 통행량(명)
  
2. 시간대별 교통수단 분담율 및 통행량 변화
  2.1 시간별(0~24시) 통행량 시각화
  2.2 시간별(0~24시) 교통수단 분담율 시각화
  
최종적으로 위의 모든 그림들을 Flexdashboard로 나타내보기!

#### 데이터 전처리 힌트

1. 읍면동별 데이터 가공 - 승용차 분담율과 승용차 통행량 변수를 뽑아야함
(원하는 데이터 형태를 연습장에 적어보세요)

```{r}
car_emd <- dat %>% 
  group_by(admi_cd) %>%
  summarise(total_cnt = n(),
            car_cnt = sum(trns_prt == "CAR")) %>%
  mutate(car_ratio = car_cnt / total_cnt)
```


2. 시군구별 데이터 가공
(위의 작업을 시군구별로 진행)

```{r}
# sf_use_s2(TRUE)
car_sgg <- dat %>%
  group_by(sgg_cd) %>%
  summarise(
    car_trip = sum(trns_prt == "CAR"),
    subway_trip = sum(trns_prt == "SUBWAY"),
    bus_trip = sum(trns_prt == "BUS"),
    total_trip = n()
  ) %>%
  mutate(car_trip_ratio = car_trip / total_trip)

region_sgg <- region %>%
  group_by(sgg_cd) %>%
  summarise(sidonm = sidonm[1], sggnm = sggnm[1])
sf_use_s2(FALSE)
```

3. 가공된 데이터에 공간정보 붙이기

```{r}
vis_emd <- region %>% left_join(car_emd, by=c("adm_cd"="admi_cd"))

vis_sgg <- region_sgg %>% left_join(car_sgg, by="sgg_cd")
```

```{r}
tmap_mode("view")

tm_shape(vis_emd)+
  tm_fill(col="car_ratio")+
  tm_borders()
```


4. 시간대별 & 교통수단별 통행 데이터 가공

```{r}
trip_by_time_and_mode <- dat %>% 
  group_by(st_timezn_cd,trns_prt) %>%
  summarise(n=n())

# RAIL_B, RAIL_N 변수를 모두 RAIL 변수로 통합
trip_by_time_and_mode <- trip_by_time_and_mode %>% 
  mutate(trns_prt = ifelse(trns_prt %in% c("RAIL_B","RAIL_N"),"RAIL",trns_prt))
```

```{r}
ggplot(data = trip_by_time_and_mode)+
  geom_bar(aes(x=st_timezn_cd,
               y=n,
               fill=trns_prt),
           stat = "identity",
           position = "stack")+
  labs(x = "Time",
       y = "Travel Volume",
       fill = "Transportation Mode")

# ggplotly(vis1)
save(list=c("vis_emd","vis_sgg","trip_by_time_and_mode"), file = "data/dat_dashboard.RData")
```

```{r}
# 비율로 바꿔줌
ggplot(data = trip_by_time_and_mode)+
  geom_bar(aes(x=st_timezn_cd,
               y=n,
               fill=trns_prt),
           stat = "identity",
           position = "fill")+
  labs(x = "Time",
       y = "Travel Volume",
       fill = "Transportation Mode")

# 여러개의 객체를 한번에 저장하고 싶을때
save(list=c("vis_emd","vis_sgg","trip_by_time_and_mode"), file = "data/dat_dashboard.RData")

```


(위에서 가공한 데이터로 X축에 시간이 y축에 교통수단별 통행량이 찍히면 됨)
(아래 링크를 참고)
barplot - https://r-graph-gallery.com/48-grouped-barplot-with-ggplot2.html  
lineplot -https://medium.com/@peteryun/r-ggplot2-multi-line-graph-example-code-9b42c22a609c


위에서 데이터 가공 및 시각화 구현을 마친 후, flexdashboard로 배치해봅시다
===============================================================

Column {data-width=650}
-----------------------------------------------------------------------

```{r}
library(flexdashboard)
library(plotly)
library(tmap)
library(scales)
tmap_mode("view")

load("data/dat_dashboard.RData")
```


### Chart A

```{r}

```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

```

### Chart C

```{r}

```

